defaults:
  - _self_
  - override hydra/job_logging: colorlog

hydra:
  verbose: false
  run:
    dir: ${run_dir}
  sweep:
    dir: ${run_dir}
    subdir: multirun_${hydra:job.num}
  job_logging:
    handlers:
      file:
        filename: ${hydra:runtime.output_dir}/${hydra:job.name}.log

seed: 0
task: train

# === Paths ===
runtime_path: ${hydra:runtime.cwd}
ckpt_dir: ${runtime_path}/runs # HAS to be absolute
run_name: ${now:%Y-%m-%d}/${now:%H-%M-%S}

cache_dir: ${ckpt_dir}/cache
run_dir: ${ckpt_dir}/jobs/${run_name}
checkpoint_path: ${run_dir}/checkpoints


# === Dataset arguments ===


dataset:
  imagenet_root: /data/360SP-data
  im_size: 128
  batch_size: 12 
  aug_scale: null
  limit: null
  num_workers: 20  # DataLoader num_workers (reduce if too many open files)
  return_all_views: true  # Enable multi-view mode (required for SSDDMultiView)

  # EquiDataset UCM parameters
  f_pix: 220.0
  xi: 0.9
  mask_mode: inscribed

  # UCM jitter parameters (for data augmentation during training)
  # Only applied to training split; validation uses no jitter
  xi_jitter: 0.1        # xi扰动范围: xi * (1 ± xi_jitter), 0表示不扰动
  f_jitter: 0.1         # f_pix扰动范围: f_pix / (1 ± f_jitter), 0表示不扰动
  jitter_target: both   # "xi" | "f" | "both" - 扰动目标

# === Model arguments ===

distill_teacher: false
ssdd:
  compile: true
  checkpoint: null

  encoder: f8c4
  encoder_checkpoint: null  # path to pretrained encoder checkpoint
  encoder_train: false
  decoder: M
  decoder_image_size: [256, 128]  # Output panorama size (W, H) - 2:1 aspect ratio

  # Multi-view specific parameters
  n_views: 4
  fusion_type: concat_conv  # "concat_conv" | "attention" | "average"
  fusion_hidden_dim: null   # Optional: override default (z_dim * 2)

  # View Encoding parameters
  use_view_encoding: true        # Enable view encoding (strongly recommended)
  view_encoding_type: sinusoidal  # "learnable" | "sinusoidal" | "directional"

  fm_sampler:
    steps: 12
    t_pow_shift: 2.0

  ema:
    decay: 0.999
    start_iter: 50_000


aux_losses:
  compile: ${ssdd.compile}
  repa:
    i_extract: 4
    n_layers: 2
  lpips: true


# === Training arguments ===

training:
  mixed_precision: bf16
  grad_accumulate: 1
  grad_clip: 0.1
  epochs: 300
  eval_freq: 1
  save_on_best: FID
  log_freq: 200
  lr: 8e-4
  weight_decay: 1e-2

losses:
  diffusion: 1
  repa: 0.25
  lpips: 0.5
  kl: 1e-6


# === Evaluation arguments ===

show_samples: 8
